<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proxy MCP Unifié - Tableau de bord</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding-top: 2rem;
      background-color: #f8f9fa;
    }
    .system-card {
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    .system-card.active {
      border-color: #28a745;
      box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    .system-card.unhealthy {
      border-color: #dc3545;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    .status-healthy {
      background-color: #28a745;
    }
    .status-unhealthy {
      background-color: #dc3545;
    }
    .log-container {
      height: 200px;
      overflow-y: auto;
      background-color: #212529;
      color: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
    }
    .log-entry {
      margin-bottom: 5px;
      border-bottom: 1px solid #343a40;
      padding-bottom: 5px;
    }
    .log-info {
      color: #17a2b8;
    }
    .log-warn {
      color: #ffc107;
    }
    .log-error {
      color: #dc3545;
    }
    .metrics-card {
      margin-bottom: 1rem;
    }
    .metrics-value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .metrics-label {
      font-size: 0.875rem;
      color: #6c757d;
    }
    .progress {
      height: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .nav-tabs .nav-link {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="pb-3 mb-4 border-bottom">
      <div class="d-flex align-items-center">
        <h1 class="display-5 fw-bold">Proxy MCP Unifié</h1>
        <div class="ms-auto">
          <span class="badge bg-primary" id="proxy-status">Chargement...</span>
        </div>
      </div>
    </header>

    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">État des systèmes</h5>
            <button class="btn btn-sm btn-outline-primary" id="refresh-btn">Actualiser</button>
          </div>
          <div class="card-body">
            <div id="systems-container" class="row">
              <!-- Les cartes des systèmes seront ajoutées ici dynamiquement -->
              <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="metrics-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview" role="tab" aria-controls="overview" aria-selected="true">Vue d'ensemble</a>
              </li>
              <li class="nav-item" role="presentation">
                <a class="nav-link" id="server-tab" data-bs-toggle="tab" href="#server" role="tab" aria-controls="server" aria-selected="false">Serveur</a>
              </li>
              <li class="nav-item" role="presentation">
                <a class="nav-link" id="systems-tab" data-bs-toggle="tab" href="#systems" role="tab" aria-controls="systems" aria-selected="false">Systèmes</a>
              </li>
              <li class="nav-item" role="presentation">
                <a class="nav-link" id="failover-tab" data-bs-toggle="tab" href="#failover" role="tab" aria-controls="failover" aria-selected="false">Basculements</a>
              </li>
              <li class="nav-item ms-auto">
                <button class="btn btn-sm btn-outline-primary" id="refresh-metrics-btn">Actualiser</button>
              </li>
            </ul>
          </div>
          <div class="card-body">
            <div class="tab-content" id="metrics-content">
              <!-- Vue d'ensemble -->
              <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                <div class="row" id="overview-metrics">
                  <div class="col-md-3">
                    <div class="card metrics-card">
                      <div class="card-body text-center">
                        <div class="metrics-value" id="total-requests">0</div>
                        <div class="metrics-label">Requêtes totales</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card metrics-card">
                      <div class="card-body text-center">
                        <div class="metrics-value" id="success-rate">0%</div>
                        <div class="metrics-label">Taux de succès</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card metrics-card">
                      <div class="card-body text-center">
                        <div class="metrics-value" id="avg-response-time">0 ms</div>
                        <div class="metrics-label">Temps de réponse moyen</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="card metrics-card">
                      <div class="card-body text-center">
                        <div class="metrics-value" id="total-failovers">0</div>
                        <div class="metrics-label">Basculements</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card metrics-card">
                      <div class="card-body">
                        <h6 class="card-title">Utilisation CPU</h6>
                        <div class="progress">
                          <div class="progress-bar" id="cpu-usage-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div class="small text-muted" id="cpu-usage-text">0%</div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card metrics-card">
                      <div class="card-body">
                        <h6 class="card-title">Utilisation mémoire</h6>
                        <div class="progress">
                          <div class="progress-bar" id="memory-usage-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div class="small text-muted" id="memory-usage-text">0%</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Métriques serveur -->
              <div class="tab-pane fade" id="server" role="tabpanel" aria-labelledby="server-tab">
                <div class="row" id="server-metrics">
                  <div class="col-md-12">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Métrique</th>
                          <th>Valeur</th>
                        </tr>
                      </thead>
                      <tbody id="server-metrics-table">
                        <!-- Les métriques serveur seront ajoutées ici dynamiquement -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Métriques des systèmes -->
              <div class="tab-pane fade" id="systems" role="tabpanel" aria-labelledby="systems-tab">
                <div id="systems-metrics">
                  <!-- Les métriques des systèmes seront ajoutées ici dynamiquement -->
                </div>
              </div>

              <!-- Métriques de basculement -->
              <div class="tab-pane fade" id="failover" role="tabpanel" aria-labelledby="failover-tab">
                <div class="row" id="failover-metrics">
                  <div class="col-md-6">
                    <div class="card metrics-card">
                      <div class="card-body">
                        <h6 class="card-title">Statistiques de basculement</h6>
                        <table class="table table-sm">
                          <tbody>
                            <tr>
                              <td>Total</td>
                              <td id="failover-total">0</td>
                            </tr>
                            <tr>
                              <td>Automatiques</td>
                              <td id="failover-auto">0</td>
                            </tr>
                            <tr>
                              <td>Manuels</td>
                              <td id="failover-manual">0</td>
                            </tr>
                            <tr>
                              <td>Dernier basculement</td>
                              <td id="failover-last-time">-</td>
                            </tr>
                            <tr>
                              <td>Raison</td>
                              <td id="failover-last-reason">-</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Journal d'activité</h5>
            <button class="btn btn-sm btn-outline-secondary" id="clear-logs-btn">Effacer</button>
          </div>
          <div class="card-body">
            <div class="log-container" id="log-container">
              <!-- Les entrées de journal seront ajoutées ici dynamiquement -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmation -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Confirmer le changement</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Êtes-vous sûr de vouloir basculer vers le système <span id="target-system"></span> ?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="confirm-switch-btn">Confirmer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Éléments DOM
      const systemsContainer = document.getElementById('systems-container');
      const proxyStatus = document.getElementById('proxy-status');
      const refreshBtn = document.getElementById('refresh-btn');
      const logContainer = document.getElementById('log-container');
      const clearLogsBtn = document.getElementById('clear-logs-btn');
      const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
      const targetSystemSpan = document.getElementById('target-system');
      const confirmSwitchBtn = document.getElementById('confirm-switch-btn');

      // Variables globales
      let activeSystem = null;
      let targetSystem = null;
      let socket = null;
      let metricsData = null;
      let metricsRefreshInterval = null;

      // Connexion WebSocket
      function connectWebSocket() {
        socket = io();

        socket.on('connect', () => {
          addLogEntry('info', 'Connexion WebSocket établie');
        });

        socket.on('disconnect', () => {
          addLogEntry('warn', 'Connexion WebSocket perdue');
        });

        socket.on('system-change', (data) => {
          addLogEntry('info', `Changement de système détecté: ${data.activeSystem}`);
          activeSystem = data.activeSystem;
          updateSystemsUI();
        });
      }

      // Charger les données initiales
      async function loadInitialData() {
        try {
          // Charger le statut du proxy
          const statusResponse = await fetch('/api/proxy/status');
          const statusData = await statusResponse.json();
          activeSystem = statusData.activeSystem;
          proxyStatus.textContent = `Système actif: ${activeSystem}`;

          // Charger la santé des systèmes
          await refreshSystemsHealth();

          // Charger les métriques
          await refreshMetrics();

          // Démarrer le rafraîchissement périodique des métriques (toutes les 10 secondes)
          metricsRefreshInterval = setInterval(refreshMetrics, 10000);

          // Connecter au WebSocket
          connectWebSocket();
        } catch (error) {
          console.error('Erreur lors du chargement des données initiales:', error);
          addLogEntry('error', `Erreur lors du chargement des données: ${error.message}`);
        }
      }

      // Rafraîchir la santé des systèmes
      async function refreshSystemsHealth() {
        try {
          const response = await fetch('/health');
          const data = await response.json();

          // Mettre à jour l'interface
          updateSystemsUI(data);

          addLogEntry('info', 'Données de santé actualisées');
        } catch (error) {
          console.error('Erreur lors de la récupération des données de santé:', error);
          addLogEntry('error', `Erreur lors de l'actualisation: ${error.message}`);
        }
      }

      // Mettre à jour l'interface des systèmes
      function updateSystemsUI(healthData = null) {
        if (healthData) {
          // Vider le conteneur
          systemsContainer.innerHTML = '';

          // Créer une carte pour chaque système
          Object.entries(healthData.systems).forEach(([system, info]) => {
            const isActive = system === activeSystem;
            const isHealthy = info.isHealthy;

            const card = document.createElement('div');
            card.className = `col-md-6 col-lg-4`;
            card.innerHTML = `
              <div class="card system-card ${isActive ? 'active' : ''} ${!isHealthy ? 'unhealthy' : ''}">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">${system}</h5>
                  <span class="status-indicator ${isHealthy ? 'status-healthy' : 'status-unhealthy'}"></span>
                </div>
                <div class="card-body">
                  <p><strong>URL:</strong> ${info.url}</p>
                  <p><strong>Priorité:</strong> ${info.priority}</p>
                  <p><strong>État:</strong> ${isHealthy ? 'En bonne santé' : 'Problème détecté'}</p>
                  <p><strong>Statut:</strong> ${isActive ? 'Actif' : 'Inactif'}</p>
                </div>
                <div class="card-footer">
                  <button class="btn btn-sm ${isActive ? 'btn-success disabled' : 'btn-primary'} switch-btn"
                          data-system="${system}"
                          ${!isHealthy || isActive ? 'disabled' : ''}>
                    ${isActive ? 'Système actif' : 'Activer ce système'}
                  </button>
                </div>
              </div>
            `;

            systemsContainer.appendChild(card);
          });

          // Ajouter les écouteurs d'événements aux boutons
          document.querySelectorAll('.switch-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              targetSystem = this.getAttribute('data-system');
              targetSystemSpan.textContent = targetSystem;
              confirmModal.show();
            });
          });
        } else {
          // Mettre à jour uniquement le statut actif
          document.querySelectorAll('.system-card').forEach(card => {
            const system = card.querySelector('.switch-btn').getAttribute('data-system');
            if (system === activeSystem) {
              card.classList.add('active');
              card.querySelector('.switch-btn').classList.add('btn-success', 'disabled');
              card.querySelector('.switch-btn').classList.remove('btn-primary');
              card.querySelector('.switch-btn').textContent = 'Système actif';
              card.querySelector('.switch-btn').disabled = true;
            } else {
              card.classList.remove('active');
              card.querySelector('.switch-btn').classList.remove('btn-success', 'disabled');
              card.querySelector('.switch-btn').classList.add('btn-primary');
              card.querySelector('.switch-btn').textContent = 'Activer ce système';
              card.querySelector('.switch-btn').disabled = card.classList.contains('unhealthy');
            }
          });

          proxyStatus.textContent = `Système actif: ${activeSystem}`;
        }
      }

      // Changer de système
      async function switchSystem(system) {
        try {
          const response = await fetch('/api/proxy/switch', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ system })
          });

          const data = await response.json();

          if (data.success) {
            addLogEntry('info', `Système changé pour: ${system}`);
            activeSystem = system;
            updateSystemsUI();
          } else {
            addLogEntry('error', `Erreur lors du changement de système: ${data.error}`);
          }
        } catch (error) {
          console.error('Erreur lors du changement de système:', error);
          addLogEntry('error', `Erreur lors du changement de système: ${error.message}`);
        }
      }

      // Ajouter une entrée au journal
      function addLogEntry(level, message) {
        const entry = document.createElement('div');
        entry.className = `log-entry log-${level}`;

        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = `[${timestamp}] [${level.toUpperCase()}] ${message}`;

        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      // Rafraîchir les métriques
      async function refreshMetrics() {
        try {
          const response = await fetch('/api/proxy/metrics');
          metricsData = await response.json();

          // Mettre à jour l'interface des métriques
          updateMetricsUI();

          addLogEntry('info', 'Métriques actualisées');
        } catch (error) {
          console.error('Erreur lors de la récupération des métriques:', error);
          addLogEntry('error', `Erreur lors de l'actualisation des métriques: ${error.message}`);
        }
      }

      // Mettre à jour l'interface des métriques
      function updateMetricsUI() {
        if (!metricsData) return;

        // Vue d'ensemble
        document.getElementById('total-requests').textContent = metricsData.server.requestsTotal;

        const successRate = metricsData.server.requestsTotal > 0
          ? Math.round((metricsData.server.requestsSuccess / metricsData.server.requestsTotal) * 100)
          : 0;
        document.getElementById('success-rate').textContent = `${successRate}%`;

        document.getElementById('avg-response-time').textContent = `${Math.round(metricsData.server.responseTimeAvg)} ms`;
        document.getElementById('total-failovers').textContent = metricsData.failover.total;

        // CPU et mémoire
        const cpuUsage = Math.round(metricsData.system.cpuUsage);
        const memoryUsage = Math.round(metricsData.system.memoryUsage);

        document.getElementById('cpu-usage-bar').style.width = `${cpuUsage}%`;
        document.getElementById('cpu-usage-bar').textContent = `${cpuUsage}%`;
        document.getElementById('cpu-usage-bar').setAttribute('aria-valuenow', cpuUsage);
        document.getElementById('cpu-usage-text').textContent = `${cpuUsage}%`;

        document.getElementById('memory-usage-bar').style.width = `${memoryUsage}%`;
        document.getElementById('memory-usage-bar').textContent = `${memoryUsage}%`;
        document.getElementById('memory-usage-bar').setAttribute('aria-valuenow', memoryUsage);
        document.getElementById('memory-usage-text').textContent = `${memoryUsage}%`;

        // Métriques serveur
        const serverMetricsTable = document.getElementById('server-metrics-table');
        serverMetricsTable.innerHTML = '';

        // Ajouter les métriques du serveur
        const serverMetrics = [
          { label: 'Temps de démarrage', value: new Date(metricsData.server.startTime).toLocaleString() },
          { label: 'Temps d\'exécution', value: formatDuration(metricsData.system.uptime) },
          { label: 'Requêtes totales', value: metricsData.server.requestsTotal },
          { label: 'Requêtes réussies', value: metricsData.server.requestsSuccess },
          { label: 'Requêtes en erreur', value: metricsData.server.requestsError },
          { label: 'Temps de réponse moyen', value: `${Math.round(metricsData.server.responseTimeAvg)} ms` },
          { label: 'Dernière requête', value: metricsData.server.lastRequestTime ? new Date(metricsData.server.lastRequestTime).toLocaleString() : '-' },
          { label: 'Utilisation CPU', value: `${cpuUsage}%` },
          { label: 'Utilisation mémoire', value: `${memoryUsage}%` }
        ];

        serverMetrics.forEach(metric => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${metric.label}</td>
            <td>${metric.value}</td>
          `;
          serverMetricsTable.appendChild(row);
        });

        // Métriques des systèmes
        const systemsMetricsContainer = document.getElementById('systems-metrics');
        systemsMetricsContainer.innerHTML = '';

        // Créer un accordeon pour chaque système
        Object.entries(metricsData.systems).forEach(([system, systemMetrics], index) => {
          const accordionItem = document.createElement('div');
          accordionItem.className = 'accordion-item';
          accordionItem.innerHTML = `
            <h2 class="accordion-header" id="heading-${system}">
              <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${system}" aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="collapse-${system}">
                ${system} ${system === activeSystem ? '<span class="badge bg-success ms-2">Actif</span>' : ''}
              </button>
            </h2>
            <div id="collapse-${system}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="heading-${system}">
              <div class="accordion-body">
                <table class="table table-sm">
                  <tbody>
                    <tr>
                      <td>Requêtes totales</td>
                      <td>${systemMetrics.requestsTotal}</td>
                    </tr>
                    <tr>
                      <td>Requêtes réussies</td>
                      <td>${systemMetrics.requestsSuccess}</td>
                    </tr>
                    <tr>
                      <td>Requêtes en erreur</td>
                      <td>${systemMetrics.requestsError}</td>
                    </tr>
                    <tr>
                      <td>Temps de réponse moyen</td>
                      <td>${Math.round(systemMetrics.responseTimeAvg)} ms</td>
                    </tr>
                    <tr>
                      <td>Vérifications de santé</td>
                      <td>${systemMetrics.healthChecks}</td>
                    </tr>
                    <tr>
                      <td>Vérifications échouées</td>
                      <td>${systemMetrics.healthChecksFailed}</td>
                    </tr>
                    <tr>
                      <td>Dernière vérification</td>
                      <td>${systemMetrics.lastHealthCheckTime ? new Date(systemMetrics.lastHealthCheckTime).toLocaleString() : '-'}</td>
                    </tr>
                    <tr>
                      <td>Dernier état</td>
                      <td>${systemMetrics.lastHealthCheckStatus === null ? '-' : (systemMetrics.lastHealthCheckStatus ? '<span class="text-success">En bonne santé</span>' : '<span class="text-danger">Problème détecté</span>')}</td>
                    </tr>
                    <tr>
                      <td>Temps actif total</td>
                      <td>${formatDuration(Math.round(systemMetrics.activeTime / 1000))}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          `;

          // Ajouter l'accordeon au conteneur
          if (index === 0) {
            const accordion = document.createElement('div');
            accordion.className = 'accordion';
            accordion.id = 'systems-accordion';
            accordion.appendChild(accordionItem);
            systemsMetricsContainer.appendChild(accordion);
          } else {
            document.getElementById('systems-accordion').appendChild(accordionItem);
          }
        });

        // Métriques de basculement
        document.getElementById('failover-total').textContent = metricsData.failover.total;
        document.getElementById('failover-auto').textContent = metricsData.failover.automatic;
        document.getElementById('failover-manual').textContent = metricsData.failover.manual;
        document.getElementById('failover-last-time').textContent = metricsData.failover.lastFailoverTime ? new Date(metricsData.failover.lastFailoverTime).toLocaleString() : '-';
        document.getElementById('failover-last-reason').textContent = metricsData.failover.lastFailoverReason || '-';
      }

      // Formater une durée en secondes en format lisible
      function formatDuration(seconds) {
        if (seconds < 60) return `${seconds} secondes`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ${seconds % 60} secondes`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)} heures ${Math.floor((seconds % 3600) / 60)} minutes`;
        return `${Math.floor(seconds / 86400)} jours ${Math.floor((seconds % 86400) / 3600)} heures`;
      }

      // Écouteurs d'événements
      refreshBtn.addEventListener('click', refreshSystemsHealth);

      document.getElementById('refresh-metrics-btn').addEventListener('click', refreshMetrics);

      clearLogsBtn.addEventListener('click', function() {
        logContainer.innerHTML = '';
        addLogEntry('info', 'Journal effacé');
      });

      confirmSwitchBtn.addEventListener('click', function() {
        switchSystem(targetSystem);
        confirmModal.hide();
      });

      // Nettoyer l'intervalle lors de la fermeture de la page
      window.addEventListener('beforeunload', function() {
        if (metricsRefreshInterval) {
          clearInterval(metricsRefreshInterval);
        }
      });

      // Charger les données initiales
      loadInitialData();
    });
  </script>
</body>
</html>
