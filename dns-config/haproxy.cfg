# Ultra-Advanced 8-Level Framework - Global Load Balancer Configuration
# Generated: 2025-06-08 21:46:54

global
    daemon
    maxconn 4096
    log stdout local0
    stats socket /var/run/haproxy.sock mode 600 level admin
    stats timeout 2m
    
    # SSL Configuration
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor
    option redispatch
    retries 3
    
    # Health checks
    option httpchk GET /health
    http-check expect status 200

# Statistics interface
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# HTTPS Frontend
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/wildcard.branching-framework.com.pem
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "DENY"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    
    # Route based on Host header
    acl is_api hdr(host) -i api.branching-framework.com
    acl is_edge hdr(host) -i edge.branching-framework.com
    acl is_admin hdr(host) -i admin.branching-framework.com
    acl is_monitoring hdr(host) -i monitoring.branching-framework.com
    
    # Geographic routing
    acl is_us src -f /etc/haproxy/geo/us.lst
    acl is_eu src -f /etc/haproxy/geo/eu.lst
    acl is_ap src -f /etc/haproxy/geo/ap.lst
    
    # Use backends based on geography and service
    use_backend api_us if is_api is_us
    use_backend api_eu if is_api is_eu
    use_backend api_ap if is_api is_ap
    use_backend api_global if is_api
    
    use_backend edge_us if is_edge is_us
    use_backend edge_eu if is_edge is_eu
    use_backend edge_ap if is_edge is_ap
    use_backend edge_global if is_edge
    
    use_backend admin_backend if is_admin
    use_backend monitoring_backend if is_monitoring
    
    default_backend main_backend

# HTTP Frontend (redirect to HTTPS)
frontend http_frontend
    bind *:80
    redirect scheme https code 301 if !{ ssl_fc }

# Regional API Backends
backend api_us
    balance roundrobin
    option httpchk GET /health
    server api-us-east-1 203.0.113.30:80 check
    server api-us-west-1 203.0.113.31:80 check

backend api_eu
    balance roundrobin
    option httpchk GET /health
    server api-eu-west-1 203.0.113.32:80 check
    server api-eu-central-1 203.0.113.33:80 check

backend api_ap
    balance roundrobin
    option httpchk GET /health
    server api-ap-southeast-1 203.0.113.34:80 check
    server api-ap-northeast-1 203.0.113.35:80 check

# Global API Backend (fallback)
backend api_global
    balance roundrobin
    option httpchk GET /health
    server api-us-east-1 203.0.113.30:80 check
    server api-eu-west-1 203.0.113.32:80 check
    server api-ap-southeast-1 203.0.113.34:80 check

# Edge Computing Backends
backend edge_us
    balance leastconn
    option httpchk GET /edge/health
    server edge-us-east-1 203.0.113.30:8080 check
    server edge-us-west-1 203.0.113.31:8080 check

backend edge_eu
    balance leastconn
    option httpchk GET /edge/health
    server edge-eu-west-1 203.0.113.32:8080 check
    server edge-eu-central-1 203.0.113.33:8080 check

backend edge_ap
    balance leastconn
    option httpchk GET /edge/health
    server edge-ap-southeast-1 203.0.113.34:8080 check
    server edge-ap-northeast-1 203.0.113.35:8080 check

backend edge_global
    balance leastconn
    option httpchk GET /edge/health
    server edge-us-east-1 203.0.113.30:8080 check
    server edge-eu-west-1 203.0.113.32:8080 check
    server edge-ap-southeast-1 203.0.113.34:8080 check

# Admin Backend
backend admin_backend
    balance roundrobin
    option httpchk GET /admin/health
    server admin-1 203.0.113.13:80 check
    server admin-2 203.0.113.13:81 check

# Monitoring Backend
backend monitoring_backend
    balance roundrobin
    option httpchk GET /api/health
    server grafana-1 203.0.113.14:3000 check
    server grafana-2 203.0.113.14:3001 check

# Main Backend
backend main_backend
    balance roundrobin
    option httpchk GET /health
    server main-1 203.0.113.10:80 check
    server main-2 203.0.113.10:81 check
