

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Développement Détaillé de la Phase 1 : Analyse et Préparation &mdash; EMAIL_SENDER_1 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            EMAIL_SENDER_1
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contenu:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">Documentation des API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">EMAIL_SENDER_1</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Développement Détaillé de la Phase 1 : Analyse et Préparation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/plans/versions/phase1-transi-restructured.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="developpement-detaille-de-la-phase-1-analyse-et-preparation">
<h1>Développement Détaillé de la Phase 1 : Analyse et Préparation<a class="headerlink" href="#developpement-detaille-de-la-phase-1-analyse-et-preparation" title="Link to this heading"></a></h1>
<section id="table-des-matieres">
<h2>Table des matières<a class="headerlink" href="#table-des-matieres" title="Link to this heading"></a></h2>
<ol class="simple">
<li><p><a class="reference external" href="#section-1">Développement Détaillé de la Phase 1 : Analyse et Préparation</a>
1.1. <a class="reference external" href="#section-2">Vue d’ensemble de la Phase 1</a>
1.1.0.1. <a class="reference external" href="#section-3">Workflow d’Inventaire Automatisé</a>
1.1.0.2. <a class="reference external" href="#section-4">Diagramme de Flux pour l’Inventaire</a>
1.1.0.3. <a class="reference external" href="#section-5">Workflow d’Analyse des Credentials</a>
1.1.0.4. <a class="reference external" href="#section-6">Diagramme de Flux pour l’Analyse des Credentials</a>
1.1.0.5. <a class="reference external" href="#section-7">Workflow d’Analyse des Expressions</a>
1.1.0.6. <a class="reference external" href="#section-8">Diagramme de Flux pour l’Analyse des Expressions</a>
1.1.0.7. <a class="reference external" href="#section-9">Diagramme de Flux pour l’Analyse des Expressions</a>
1.1.0.8. <a class="reference external" href="#section-10">Workflow de Duplication Automatisée</a>
1.1.0.9. <a class="reference external" href="#section-11">Diagramme de Flux pour la Duplication des Workflows</a>
1.1.0.10. <a class="reference external" href="#section-12">Workflow de Configuration des Bases de Données de Test</a>
1.1.0.11. <a class="reference external" href="#section-13">Diagramme de Flux pour la Configuration des Bases de Données de Test</a>
1.1.0.12. <a class="reference external" href="#section-14">Workflow de Création du Système de Journalisation</a>
1.1.0.13. <a class="reference external" href="#section-15">Diagramme de Flux pour le Système de Journalisation</a>
1.1.0.14. <a class="reference external" href="#section-16">Diagramme d’Intégration du Système de Journalisation dans les Workflows de Test</a>
1.1.1. <a class="reference external" href="#section-17">Liens avec les Phases Précédentes</a>
1.1.2. <a class="reference external" href="#section-18">Liens avec les Phases Suivantes</a>
1.1.3. <a class="reference external" href="#section-19">Tâches Régulières Répétitives</a>
1.1.4. <a class="reference external" href="#section-20">Événements de Fond</a>
1.2. <a class="reference external" href="#section-21">Conclusion</a></p></li>
</ol>
</section>
<section id="developpement-detaille-de-la-phase-1-analyse-et-preparation-a-name-section-1-a">
<h2>1. Développement Détaillé de la Phase 1 : Analyse et Préparation <a name='section-1'></a><a class="headerlink" href="#developpement-detaille-de-la-phase-1-analyse-et-preparation-a-name-section-1-a" title="Link to this heading"></a></h2>
<section id="vue-d-ensemble-de-la-phase-1-a-name-section-2-a">
<h3>1.1. Vue d’ensemble de la Phase 1 <a name='section-2'></a><a class="headerlink" href="#vue-d-ensemble-de-la-phase-1-a-name-section-2-a" title="Link to this heading"></a></h3>
<p>La Phase 1 est cruciale car elle pose les fondations de tout le processus de transition. Elle comprend deux étapes principales :</p>
<ol class="simple">
<li><p>Audit des Workflows Existants</p></li>
<li><p>Création d’un Environnement de Test</p></li>
</ol>
<p>Voici une représentation ASCII de la structure globale de cette phase :<br />Copy<br />PHASE 1: ANALYSE ET PRÉPARATION<br />│<br />├── ÉTAPE 1.1: AUDIT DES WORKFLOWS EXISTANTS<br />│   ├── Inventaire des Nœuds et Fonctionnalités<br />│   ├── Analyse des Credentials<br />│   └── Évaluation des Expressions et Variables<br />└── ÉTAPE 1.2: CRÉATION D’UN ENVIRONNEMENT DE TEST<br />├── Duplication des Workflows<br />├── Configuration des Bases de Données de Test<br />└── Mise en Place d’un Système de Journalisation</p>
<section id="workflow-d-inventaire-automatise-a-name-section-3-a">
<h4>1.1.0.1. Workflow d’Inventaire Automatisé <a name='section-3'></a><a class="headerlink" href="#workflow-d-inventaire-automatise-a-name-section-3-a" title="Link to this heading"></a></h4>
<p>Pour réaliser l’inventaire des nœuds et fonctionnalités, nous allons créer un workflow d’analyse qui parcourt tous les workflows existants et génère un rapport détaillé.<br />Nœuds nécessaires :</p>
<ol>
<li><p>Start Node (Manual Trigger)</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.manualTrigger</p></li>
<li><p>Configuration : Standard</p></li>
</ul>
</li>
<li><p>Get Workflows</p>
<ul>
<li><p>Type : n8n-nodes-base.n8n</p></li>
<li><p>Configuration :</p></li>
<li><p>Copy</p></li>
<li><p>{</p></li>
<li><p>“resource”: “workflow”,</p></li>
<li><p>“operation”: “getAll”,</p></li>
<li><p>“options”: {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span>  
</pre></div>
</div>
</li>
<li><p>}</p></li>
</ul>
</li>
<li><p>Filter Email Sender Workflows</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.code</p></li>
<li><p>// Filtrer uniquement les workflows Email Sender</p></li>
<li><p>return items.filter(item =&gt; {</p></li>
<li><p>const name = item.json.name || ‘’;</p></li>
<li><p>return name.includes(’EMAIL_SENDER’) || name.includes(’Email Sender’);</p></li>
<li><p>});</p></li>
</ul>
</li>
<li><p>Extract Nodes Information</p>
<ul>
<li><p>const workflowsAnalysis = [];</p></li>
<li><p>for (const item of items) {</p></li>
<li><p>const workflow = item.json;</p></li>
<li><p>const nodes = workflow.nodes || [];</p></li>
<li><p>const nodeTypes = {};</p></li>
<li><p>const credentials = {};</p></li>
<li><p>const expressions = new Set();</p></li>
<li></li>
<li><p>// Analyser chaque nœud</p></li>
<li><p>for (const node of nodes) {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Compter</span> <span class="n">les</span> <span class="n">types</span> <span class="n">de</span> <span class="n">nœuds</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">nodeType</span> \<span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">||</span> <span class="s1">&#39;unknown&#39;</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nodeTypes</span>\<span class="p">[</span><span class="n">nodeType</span>\<span class="p">]</span> \<span class="o">=</span> <span class="p">(</span><span class="n">nodeTypes</span>\<span class="p">[</span><span class="n">nodeType</span>\<span class="p">]</span> <span class="o">||</span> <span class="mi">0</span>\<span class="p">)</span> \<span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Collecter</span> <span class="n">les</span> <span class="n">credentials</span> <span class="n">utilisés</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">credentials</span><span class="p">)</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Object</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">credentials</span><span class="p">)</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">credType</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">const</span> <span class="n">credName</span> \<span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">credentials</span>\<span class="p">[</span><span class="n">credType</span>\<span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">||</span> <span class="s1">&#39;unnamed&#39;</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">credentials</span>\<span class="p">[</span><span class="n">credType</span>\<span class="p">]</span> \<span class="o">=</span> <span class="n">credentials</span>\<span class="p">[</span><span class="n">credType</span>\<span class="p">]</span> <span class="o">||</span> \<span class="p">[</span>\<span class="p">];</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    if (\!credentials\[credType\].includes(credName)) {  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">credentials</span>\<span class="p">[</span><span class="n">credType</span>\<span class="p">]</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">credName</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Rechercher</span> <span class="n">les</span> <span class="n">expressions</span> <span class="n">dans</span> <span class="n">les</span> <span class="n">paramètres</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">findExpressions</span> \<span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="k">if</span> <span class="p">(</span><span class="n">typeof</span> <span class="n">obj</span> \<span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="s1">&#39;{{&#39;</span><span class="p">))</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">//</span> <span class="n">Extraire</span> <span class="n">les</span> <span class="n">expressions</span> <span class="n">entre</span> <span class="p">{{</span> <span class="n">et</span> <span class="p">}}</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">const</span> <span class="n">matches</span> \<span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="o">/</span>\\<span class="p">{</span>\\<span class="p">{(</span>\<span class="p">[</span><span class="o">^</span><span class="p">}</span>\<span class="p">]</span><span class="o">+</span><span class="p">)</span>\\<span class="p">}</span>\\<span class="p">}</span><span class="o">/</span><span class="n">g</span><span class="p">)</span> <span class="o">||</span> \<span class="p">[</span>\<span class="p">];</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">matches</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">match</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="n">expressions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">match</span><span class="p">));</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">typeof</span> <span class="n">obj</span> \<span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span> \<span class="o">!==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">Object</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">val</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="n">findExpressions</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">};</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">findExpressions</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parameters</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><p>// Analyser les connexions</p></li>
<li><p>const connections = workflow.connections || {};</p></li>
<li><p>const connectionMap = {};</p></li>
<li><p>Object.entries(connections).forEach(([sourceNodeName, sourceConnections]) =&gt;</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">connectionMap</span>\<span class="p">[</span><span class="n">sourceNodeName</span>\<span class="p">]</span> \<span class="o">=</span> <span class="n">connectionMap</span>\<span class="p">[</span><span class="n">sourceNodeName</span>\<span class="p">]</span> <span class="o">||</span> \<span class="p">[</span>\<span class="p">];</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">sourceConnections</span><span class="o">.</span><span class="n">main</span><span class="p">)</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">sourceConnections</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">forEach</span><span class="p">((</span><span class="n">outputs</span><span class="p">,</span> <span class="n">outputIndex</span><span class="p">)</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">outputs</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">connection</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">connectionMap</span>\<span class="p">[</span><span class="n">sourceNodeName</span>\<span class="p">]</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">node</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><p>// Ajouter l’analyse de ce workflow</p></li>
<li><p>workflowsAnalysis.push({</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">json</span><span class="p">:</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">workflowId</span><span class="p">:</span> <span class="n">workflow</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">workflowName</span><span class="p">:</span> <span class="n">workflow</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">nodeCount</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">nodeTypes</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">credentials</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressions</span><span class="p">:</span> <span class="n">Array</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">expressions</span><span class="p">),</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">connections</span><span class="p">:</span> <span class="n">connectionMap</span>  
</pre></div>
</div>
</li>
<li><p>return workflowsAnalysis;</p></li>
</ul>
</li>
<li><p>Generate Inventory Report</p>
<ul>
<li><p>// Générer un rapport d’inventaire au format Markdown</p></li>
<li><p>const workflowsData = items.map(item =&gt; item.json);</p></li>
<li><p>let report = `# Inventaire des Workflows Email Sender\n\n`;</p></li>
<li><p>report += `Date de génération: ${new Date().toISOString()}\n\n`;</p></li>
<li><p>report += `## Vue d’ensemble\n\n`;</p></li>
<li><p>report += `Nombre total de workflows: ${workflowsData.length}\n\n`;</p></li>
<li><p>// Tableau des workflows</p></li>
<li><p>report += `## Liste des Workflows\n\n`;</p></li>
<li><p>report += `| ID | Nom | Nombre de Nœuds |\n`;</p></li>
<li><p>report += `|—–|—–|—————|\n`;</p></li>
<li><p>workflowsData.forEach(wf =&gt; {</p></li>
<li><p>report += `| ${wf.workflowId} | ${wf.workflowName} | ${wf.nodeCount} |\n`;</p></li>
<li><p>// Statistiques sur les types de nœuds</p></li>
<li><p>report += `\n## Types de Nœuds Utilisés\n\n`;</p></li>
<li><p>const allNodeTypes = {};</p></li>
<li><p>Object.entries(wf.nodeTypes).forEach(([type, count]) =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">allNodeTypes</span>\<span class="p">[</span><span class="nb">type</span>\<span class="p">]</span> \<span class="o">=</span> <span class="p">(</span><span class="n">allNodeTypes</span>\<span class="p">[</span><span class="nb">type</span>\<span class="p">]</span> <span class="o">||</span> <span class="mi">0</span>\<span class="p">)</span> \<span class="o">+</span> <span class="n">count</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><p>report += `| Type de Nœud | Nombre d’Occurrences |\n`;</p></li>
<li><p>report += `|————-|———————-|\n`;</p></li>
<li><p>Object.entries(allNodeTypes)</p></li>
<li><p>.sort((a, b) =&gt; b[1] - a[1])</p></li>
<li><p>.forEach(([type, count]) =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>report \+= \`| ${type} | ${count} |\\n\`;  
</pre></div>
</div>
</li>
<li><p>// Credentials utilisés</p></li>
<li><p>report += `\n## Credentials Utilisés\n\n`;</p></li>
<li><p>const allCredentials = {};</p></li>
<li><p>Object.entries(wf.credentials).forEach(([type, names]) =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">allCredentials</span>\<span class="p">[</span><span class="nb">type</span>\<span class="p">]</span> \<span class="o">=</span> <span class="n">allCredentials</span>\<span class="p">[</span><span class="nb">type</span>\<span class="p">]</span> <span class="o">||</span> <span class="n">new</span> <span class="n">Set</span><span class="p">();</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">names</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">name</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="n">allCredentials</span>\<span class="p">[</span><span class="nb">type</span>\<span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>  
</pre></div>
</div>
</li>
<li><p>report += `| Type de Credential | Noms |\n`;</p></li>
<li><p>report += `|——————-|——|\n`;</p></li>
<li><p>Object.entries(allCredentials).forEach(([type, namesSet]) =&gt; {</p></li>
<li><p>const names = Array.from(namesSet).join(’, ‘);</p></li>
<li><p>report += `| ${type} | ${names} |\n`;</p></li>
<li><p>// Expressions utilisées</p></li>
<li><p>report += `\n## Expressions Couramment Utilisées\n\n`;</p></li>
<li><p>const expressionCount = {};</p></li>
<li><p>wf.expressions.forEach(expr =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expressionCount</span>\<span class="p">[</span><span class="n">expr</span>\<span class="p">]</span> \<span class="o">=</span> <span class="p">(</span><span class="n">expressionCount</span>\<span class="p">[</span><span class="n">expr</span>\<span class="p">]</span> <span class="o">||</span> <span class="mi">0</span>\<span class="p">)</span> \<span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><p>report += `| Expression | Nombre d’Occurrences |\n`;</p></li>
<li><p>report += `|————|———————-|\n`;</p></li>
<li><p>Object.entries(expressionCount)</p></li>
<li><p>.slice(0, 20) // Top 20 des expressions les plus utilisées</p></li>
<li><p>.forEach(([expr, count]) =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>report \+= \`| \\\`${expr}\\\` | ${count} |\\n\`;  
</pre></div>
</div>
</li>
<li><p>// Analyse des dépendances entre workflows</p></li>
<li><p>report += `\n## Dépendances entre Workflows\n\n`;</p></li>
<li><p>// Cette partie nécessiterait une analyse plus approfondie des connexions</p></li>
<li><p>// entre les workflows, ce qui pourrait être complexe à automatiser.</p></li>
<li><p>report += `*Cette section nécessite une analyse manuelle approfondie.*\n\n`;</p></li>
<li><p>// Détails par workflow</p></li>
<li><p>report += `\n## Détails par Workflow\n\n`;</p></li>
<li><p>report += `### ${wf.workflowName}\n\n`;</p></li>
<li><p>report += `- **ID**: ${wf.workflowId}\n`;</p></li>
<li><p>report += `- **Nombre de nœuds**: ${wf.nodeCount}\n\n`;</p></li>
<li><p>report += `#### Types de Nœuds\n\n`;</p></li>
<li><p>report += `| Type | Nombre |\n`;</p></li>
<li><p>report += `|——|——–|\n`;</p></li>
<li><p>Object.entries(wf.nodeTypes)</p></li>
<li><p>report += `\n#### Flux de Données\n\n`;</p></li>
<li><p>report += `\`\`\`\n`;</p></li>
<li><p>// Représentation ASCII du flux de données</p></li>
<li><p>const processedNodes = new Set();</p></li>
<li><p>const renderFlow = (nodeName, depth = 0) =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">processedNodes</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">nodeName</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">processedNodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nodeName</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">indent</span> \<span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>report \+= \`${indent}${nodeName}\\n\`;  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">connections</span>\<span class="p">[</span><span class="n">nodeName</span>\<span class="p">])</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">wf</span><span class="o">.</span><span class="n">connections</span>\<span class="p">[</span><span class="n">nodeName</span>\<span class="p">]</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">targetNode</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    report \+= \`${indent}  ↓\\n\`;  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">renderFlow</span><span class="p">(</span><span class="n">targetNode</span><span class="p">,</span> <span class="n">depth</span> \<span class="o">+</span> <span class="mi">1</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><p>// Trouver les nœuds de départ (sans connexions entrantes)</p></li>
<li><p>const allTargetNodes = new Set();</p></li>
<li><p>Object.values(wf.connections).forEach(targets =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">targets</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">target</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="n">allTargetNodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target</span><span class="p">));</span>  
</pre></div>
</div>
</li>
<li><p>const startNodes = Object.keys(wf.connections).filter(node =&gt;</p></li>
<li><p>!allTargetNodes.has(node));</p></li>
<li><p>startNodes.forEach(startNode =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">renderFlow</span><span class="p">(</span><span class="n">startNode</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><p>report += `\`\`\`\n\n`;</p></li>
<li><p>return [{ json: { report } }];</p></li>
</ul>
</li>
<li><p>Save Report to File</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.writeTextFile</p></li>
<li><p>“fileName”: “EMAIL_SENDER_INVENTORY_REPORT.md”,</p></li>
<li><p>“text”: “={{ $json.report }}”,</p></li>
<li><p>“append”: false,</p></li>
<li><p>“encoding”: “utf8”</p></li>
</ul>
</li>
</ol>
</section>
<section id="diagramme-de-flux-pour-l-inventaire-a-name-section-4-a">
<h4>1.1.0.2. Diagramme de Flux pour l’Inventaire <a name='section-4'></a><a class="headerlink" href="#diagramme-de-flux-pour-l-inventaire-a-name-section-4-a" title="Link to this heading"></a></h4>
<p>Copy<br />┌─────────────────┐     ┌───────────────┐     ┌──────────────────────┐<br />│                 │     │               │     │                      │<br />│  Manual Trigger │────▶│ Get Workflows │────▶│ Filter Email Sender  │<br />│                 │     │               │     │      Workflows       │<br />└─────────────────┘     └───────────────┘     └──────────────────────┘<br />│<br />▼<br />┌─────────────────┐     ┌───────────────────┐     ┌──────────────────┐<br />│  Save Report    │◀────│ Generate Inventory│◀────│ Extract Nodes    │<br />│    to File      │     │      Report       │     │   Information    │<br />└─────────────────┘     └───────────────────┘     └──────────────────┘</p>
</section>
<section id="workflow-d-analyse-des-credentials-a-name-section-5-a">
<h4>1.1.0.3. Workflow d’Analyse des Credentials <a name='section-5'></a><a class="headerlink" href="#workflow-d-analyse-des-credentials-a-name-section-5-a" title="Link to this heading"></a></h4>
<p>Pour analyser les credentials utilisés dans les workflows existants, nous allons créer un workflow spécifique.<br />Nœuds nécessaires :</p>
<ol>
<li><p>Start Node (Manual Trigger)</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.manualTrigger</p></li>
<li><p>Configuration : Standard</p></li>
</ul>
</li>
<li><p>Get Credentials</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.n8n</p></li>
<li><p>Configuration :</p></li>
<li><p>Copy</p></li>
<li><p>{</p></li>
<li><p>“resource”: “credential”,</p></li>
<li><p>“operation”: “getAll”</p></li>
<li><p>}</p></li>
</ul>
</li>
<li><p>Extract Credentials Info</p>
<ul>
<li><p>Type : n8n-nodes-base.code</p></li>
<li><p>// Extraire les informations pertinentes sur les credentials</p></li>
<li><p>const credentialsInfo = [];</p></li>
<li><p>for (const item of items) {</p></li>
<li><p>const credential = item.json;</p></li>
<li></li>
<li><p>credentialsInfo.push({</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">json</span><span class="p">:</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="nb">id</span><span class="p">:</span> <span class="n">credential</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">name</span><span class="p">:</span> <span class="n">credential</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="nb">type</span><span class="p">:</span> <span class="n">credential</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">createdAt</span><span class="p">:</span> <span class="n">credential</span><span class="o">.</span><span class="n">createdAt</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">updatedAt</span><span class="p">:</span> <span class="n">credential</span><span class="o">.</span><span class="n">updatedAt</span>  
</pre></div>
</div>
</li>
<li><p>});</p></li>
<li><p>return credentialsInfo;</p></li>
</ul>
</li>
<li><p>Get Workflows for Credential Usage</p>
<ul class="simple">
<li><p>“resource”: “workflow”,</p></li>
</ul>
</li>
<li><p>Analyze Credential Usage</p>
<ul>
<li><p>// Analyser l’utilisation des credentials dans les workflows</p></li>
<li><p>const credentials = $input.item(0).json;</p></li>
<li><p>const workflows = $input.item(1).json;</p></li>
<li><p>// Créer un mapping des credentials par ID pour un accès rapide</p></li>
<li><p>const credentialsById = {};</p></li>
<li><p>credentials.forEach(cred =&gt; {</p></li>
<li><p>credentialsById[cred.id] = cred;</p></li>
<li><p>// Analyser l’utilisation des credentials dans chaque workflow</p></li>
<li><p>const credentialUsage = {};</p></li>
<li><p>workflows.forEach(workflow =&gt; {</p></li>
<li><p>const nodes = workflow.nodes || [];</p></li>
<li><p>nodes.forEach(node =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">credentials</span><span class="p">)</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Object</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">credentials</span><span class="p">)</span><span class="o">.</span><span class="n">forEach</span><span class="p">((</span>\<span class="p">[</span><span class="n">credType</span><span class="p">,</span> <span class="n">credInfo</span>\<span class="p">])</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">const</span> <span class="n">credId</span> \<span class="o">=</span> <span class="n">credInfo</span><span class="o">.</span><span class="n">id</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="p">(</span><span class="n">credId</span><span class="p">)</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">credentialUsage</span>\<span class="p">[</span><span class="n">credId</span>\<span class="p">]</span> \<span class="o">=</span> <span class="n">credentialUsage</span>\<span class="p">[</span><span class="n">credId</span>\<span class="p">]</span> <span class="o">||</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="n">credential</span><span class="p">:</span> <span class="n">credentialsById</span>\<span class="p">[</span><span class="n">credId</span>\<span class="p">]</span> <span class="o">||</span> <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="n">credId</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span>   
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">credType</span> <span class="p">},</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="n">workflows</span><span class="p">:</span> <span class="n">new</span> <span class="n">Set</span><span class="p">(),</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="n">nodeTypes</span><span class="p">:</span> <span class="n">new</span> <span class="n">Set</span><span class="p">()</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="p">};</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">credentialUsage</span>\<span class="p">[</span><span class="n">credId</span>\<span class="p">]</span><span class="o">.</span><span class="n">workflows</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">credentialUsage</span>\<span class="p">[</span><span class="n">credId</span>\<span class="p">]</span><span class="o">.</span><span class="n">nodeTypes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">type</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><p>// Convertir les ensembles en tableaux pour le rapport</p></li>
<li><p>const usageReport = Object.values(credentialUsage).map(usage =&gt; ({</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">credentialId</span><span class="p">:</span> <span class="n">usage</span><span class="o">.</span><span class="n">credential</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">credentialName</span><span class="p">:</span> <span class="n">usage</span><span class="o">.</span><span class="n">credential</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">credentialType</span><span class="p">:</span> <span class="n">usage</span><span class="o">.</span><span class="n">credential</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">workflowCount</span><span class="p">:</span> <span class="n">usage</span><span class="o">.</span><span class="n">workflows</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">workflows</span><span class="p">:</span> <span class="n">Array</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">workflows</span><span class="p">),</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nodeTypes</span><span class="p">:</span> <span class="n">Array</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">nodeTypes</span><span class="p">)</span>  
</pre></div>
</div>
</li>
<li><p>}));</p></li>
<li><p>return usageReport;</p></li>
</ul>
</li>
<li><p>Generate Credentials Report</p>
<ul>
<li><p>// Générer un rapport sur l’utilisation des credentials</p></li>
<li><p>const usageData = items.map(item =&gt; item.json);</p></li>
<li><p>let report = `# Analyse des Credentials pour Email Sender\n\n`;</p></li>
<li><p>report += `Date de génération: ${new Date().toISOString()}\n\n`;</p></li>
<li><p>report += `## Vue d’ensemble\n\n`;</p></li>
<li><p>report += `Nombre total de credentials analysés: ${usageData.length}\n\n`;</p></li>
<li><p>// Tableau des credentials</p></li>
<li><p>report += `## Liste des Credentials\n\n`;</p></li>
<li><p>report += `| ID | Nom | Type | Nombre de Workflows |\n`;</p></li>
<li><p>report += `|—–|—–|——|——————–|\n`;</p></li>
<li><p>usageData.forEach(cred =&gt; {</p></li>
<li><p>report += `| ${cred.credentialId} | ${cred.credentialName} | ${cred.</p></li>
<li><p>credentialType} | ${cred.workflowCount} |\n`;</p></li>
<li><p>// Détails par credential</p></li>
<li><p>report += `\n## Détails par Credential\n\n`;</p></li>
<li><p>report += `### ${cred.credentialName} (${cred.credentialType})\n\n`;</p></li>
<li><p>report += `- **ID**: ${cred.credentialId}\n`;</p></li>
<li><p>report += `- **Utilisé dans ${cred.workflowCount} workflow(s)**\n\n`;</p></li>
<li><p>report += `#### Workflows\n\n`;</p></li>
<li><p>cred.workflows.forEach(wf =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>report \+= \`- ${wf}\\n\`;  
</pre></div>
</div>
</li>
<li><p>report += `\n#### Types de Nœuds\n\n`;</p></li>
<li><p>cred.nodeTypes.forEach(nodeType =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>report \+= \`- ${nodeType}\\n\`;  
</pre></div>
</div>
</li>
<li><p>report += `\n`;</p></li>
<li><p>// Recommandations</p></li>
<li><p>report += `## Recommandations\n\n`;</p></li>
<li><p>// Identifier les credentials potentiellement réutilisables</p></li>
<li><p>const reusableCredentials = usageData.filter(cred =&gt; cred.workflowCount === 1);</p></li>
<li><p>if (reusableCredentials.length &gt; 0) {</p></li>
<li><p>report += `### Credentials Potentiellement Réutilisables\n\n`;</p></li>
<li><p>report += `Les credentials suivants ne sont utilisés que dans un seul</p></li>
<li><p>workflow et pourraient être réutilisés dans la nouvelle architecture:\n\n`;</p></li>
<li><p>reusableCredentials.forEach(cred =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>report \+= \`- \*\*${cred.credentialName}\*\* (${cred.credentialType}) \-   
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Actuellement utilisé dans: ${cred.workflows\[0\]}\\n\`;  
</pre></div>
</div>
</li>
<li><p>// Identifier les services externes utilisés</p></li>
<li><p>const serviceTypes = new Set();</p></li>
<li><p>serviceTypes.add(cred.credentialType);</p></li>
<li><p>report += `\n### Services Externes Utilisés\n\n`;</p></li>
<li><p>Array.from(serviceTypes).forEach(service =&gt; {</p></li>
<li><p>report += `- ${service}\n`;</p></li>
<li><p>return [{ json: { report } }];</p></li>
</ul>
</li>
<li><p>Save Credentials Report</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.writeTextFile</p></li>
<li><p>“fileName”: “EMAIL_SENDER_CREDENTIALS_REPORT.md”,</p></li>
<li><p>“text”: “={{ $json.report }}”,</p></li>
<li><p>“append”: false,</p></li>
<li><p>“encoding”: “utf8”</p></li>
</ul>
</li>
</ol>
</section>
<section id="diagramme-de-flux-pour-l-analyse-des-credentials-a-name-section-6-a">
<h4>1.1.0.4. Diagramme de Flux pour l’Analyse des Credentials <a name='section-6'></a><a class="headerlink" href="#diagramme-de-flux-pour-l-analyse-des-credentials-a-name-section-6-a" title="Link to this heading"></a></h4>
<p>Copy<br />┌─────────────────┐     ┌───────────────┐     ┌──────────────────────┐<br />│                 │     │               │     │                      │<br />│  Manual Trigger │────▶│ Get Credentials │──┬─▶│ Extract Credentials  │<br />│                 │     │               │  │  │      Info            │<br />└─────────────────┘     └───────────────┘  │  └──────────────────────┘<br />│             │<br />│             ▼<br />│  ┌──────────────────────┐<br />│  │                      │<br />└─▶│ Get Workflows for    │<br />│  Credential Usage    │<br />└──────────────────────┘<br />│<br />▼<br />┌─────────────────┐     ┌───────────────────┐     ┌──────────────────┐<br />│  Save Credentials│◀────│ Generate Credentials│◀────│ Analyze Credential│<br />│    Report       │     │      Report       │     │      Usage       │<br />└─────────────────┘     └───────────────────┘     └──────────────────┘</p>
</section>
<section id="workflow-d-analyse-des-expressions-a-name-section-7-a">
<h4>1.1.0.5. Workflow d’Analyse des Expressions <a name='section-7'></a><a class="headerlink" href="#workflow-d-analyse-des-expressions-a-name-section-7-a" title="Link to this heading"></a></h4>
<p>Pour évaluer les expressions et variables utilisées dans les workflows, nous allons créer un workflow d’analyse spécifique.<br />Nœuds nécessaires :</p>
<ol>
<li><p>Start Node (Manual Trigger)</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.manualTrigger</p></li>
<li><p>Configuration : Standard</p></li>
</ul>
</li>
<li><p>Get Workflows</p>
<ul>
<li><p>Type : n8n-nodes-base.n8n</p></li>
<li><p>Configuration :</p></li>
<li><p>Copy</p></li>
<li><p>{</p></li>
<li><p>“resource”: “workflow”,</p></li>
<li><p>“operation”: “getAll”,</p></li>
<li><p>“options”: {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span>  
</pre></div>
</div>
</li>
<li><p>}</p></li>
</ul>
</li>
<li><p>Filter Email Sender Workflows</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.code</p></li>
<li><p>// Filtrer uniquement les workflows Email Sender</p></li>
<li><p>return items.filter(item =&gt; {</p></li>
<li><p>const name = item.json.name || ‘’;</p></li>
<li><p>return name.includes(’EMAIL_SENDER’) || name.includes(’Email Sender’);</p></li>
<li><p>});</p></li>
</ul>
</li>
<li><p>Extract Expressions</p>
<ul>
<li><p>// Extraire toutes les expressions des workflows</p></li>
<li><p>const workflowExpressions = [];</p></li>
<li><p>for (const item of items) {</p></li>
<li><p>const workflow = item.json;</p></li>
<li><p>const nodes = workflow.nodes || [];</p></li>
<li><p>const expressions = [];</p></li>
<li></li>
<li><p>// Fonction récursive pour trouver les expressions dans un objet</p></li>
<li><p>const findExpressions = (obj, path = ‘’) =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">typeof</span> <span class="n">obj</span> \<span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="s1">&#39;{{&#39;</span><span class="p">))</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Extraire</span> <span class="n">les</span> <span class="n">expressions</span> <span class="n">entre</span> <span class="p">{{</span> <span class="n">et</span> <span class="p">}}</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">const</span> <span class="n">matches</span> \<span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="o">/</span>\\<span class="p">{</span>\\<span class="p">{(</span>\<span class="p">[</span><span class="o">^</span><span class="p">}</span>\<span class="p">]</span><span class="o">+</span><span class="p">)</span>\\<span class="p">}</span>\\<span class="p">}</span><span class="o">/</span><span class="n">g</span><span class="p">)</span> <span class="o">||</span> \<span class="p">[</span>\<span class="p">];</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">matches</span><span class="o">.</span><span class="n">forEach</span><span class="p">(</span><span class="n">match</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">expressions</span><span class="o">.</span><span class="n">push</span><span class="p">({</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">expression</span><span class="p">:</span> <span class="n">match</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">path</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="n">cleaned</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">/</span>\\<span class="p">{</span>\\<span class="p">{</span><span class="o">|</span>\\<span class="p">}</span>\\<span class="p">}</span><span class="o">/</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">typeof</span> <span class="n">obj</span> \<span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span> \<span class="o">!==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Object</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">forEach</span><span class="p">((</span>\<span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span>\<span class="p">])</span> \<span class="o">=</span>\<span class="o">&gt;</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    const newPath \= path ? \`${path}.${key}\` : key;  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">findExpressions</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">newPath</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><p>};</p></li>
<li><p>// Analyser chaque nœud</p></li>
<li><p>nodes.forEach(node =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  findExpressions(node.parameters, \`${node.name}.parameters\`);  
</pre></div>
</div>
</li>
<li><p>// Regrouper les expressions par type</p></li>
<li><p>const expressionTypes = {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">json</span><span class="p">:</span> \<span class="p">[</span>\<span class="p">],</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span><span class="p">:</span> \<span class="p">[</span>\<span class="p">],</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">input</span><span class="p">:</span> \<span class="p">[</span>\<span class="p">],</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">item</span><span class="p">:</span> \<span class="p">[</span>\<span class="p">],</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parameters</span><span class="p">:</span> \<span class="p">[</span>\<span class="p">],</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="p">:</span> \<span class="p">[</span>\<span class="p">],</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span><span class="p">:</span> \<span class="p">[</span>\<span class="p">],</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">other</span><span class="p">:</span> \<span class="p">[</span>\<span class="p">]</span>  
</pre></div>
</div>
</li>
<li><p>expressions.forEach(expr =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">cleaned</span> \<span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">cleaned</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s1">&#39;$json&#39;</span><span class="p">))</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressionTypes</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s1">&#39;$node&#39;</span><span class="p">))</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressionTypes</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s1">&#39;$input&#39;</span><span class="p">))</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressionTypes</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s1">&#39;$item&#39;</span><span class="p">))</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressionTypes</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s1">&#39;$parameter&#39;</span><span class="p">))</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressionTypes</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s1">&#39;$env&#39;</span><span class="p">))</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressionTypes</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s1">&#39;$workflow&#39;</span><span class="p">))</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressionTypes</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressionTypes</span><span class="o">.</span><span class="n">other</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">expr</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><p>workflowExpressions.push({</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">json</span><span class="p">:</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">workflowId</span><span class="p">:</span> <span class="n">workflow</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">workflowName</span><span class="p">:</span> <span class="n">workflow</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressionCount</span><span class="p">:</span> <span class="n">expressions</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressions</span><span class="p">:</span> <span class="n">expressions</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">expressionTypes</span><span class="p">:</span> <span class="n">expressionTypes</span>  
</pre></div>
</div>
</li>
<li><p>return workflowExpressions;</p></li>
</ul>
</li>
<li><p>Generate Expressions Report</p>
<ul>
<li><p>// Générer un rapport sur les expressions utilisées</p></li>
<li><p>const workflowsData = items.map(item =&gt; item.json);</p></li>
<li><p>let report = `# Analyse des Expressions pour Email Sender\n\n`;</p></li>
<li><p>report += `Date de génération: ${new Date().toISOString()}\n\n`;</p></li>
<li><p>report += `## Vue d’ensemble\n\n`;</p></li>
<li><p>report += `Nombre total de workflows analysés: ${workflowsData.length}\n\n`;</p></li>
<li><p>// Tableau des workflows</p></li>
<li><p>report += `## Expressions par Workflow\n\n`;</p></li>
<li><p>report += `| Workflow | Nombre d’Expressions | $json | $node | $input |</p></li>
<li><p>$item | $parameter | $env | $workflow | Autres |\n`;</p></li>
<li><p>report += `|———-|———————|——-|——-|——–|——-|</p></li>
<li><p>-———–|——|———–|——–|\n`;</p></li>
<li><p>workflowsData.forEach(wf =&gt; {</p></li>
<li><p>const types = wf.expressionTypes;</p></li>
<li><p>report += `| ${wf.workflowName} | ${wf.expressionCount} | ${types.json.</p></li>
<li><p>length} | ${types.node.length} | ${types.input.length} | ${types.item.</p></li>
<li><p>length} | ${types.parameters.length} | ${types.env.length} | ${types.</p></li>
<li><p>workflow.length} | ${types.other.length} |\n`;</p></li>
<li><p>// Expressions courantes</p></li>
<li><p>report += `\n## Expressions $json Courantes\n\n`;</p></li>
<li><p>const allJsonExpressions = {};</p></li>
<li><p>wf.expressionTypes.json.forEach(expr =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">allJsonExpressions</span>\<span class="p">[</span><span class="n">cleaned</span>\<span class="p">]</span> \<span class="o">=</span> <span class="p">(</span><span class="n">allJsonExpressions</span>\<span class="p">[</span><span class="n">cleaned</span>\<span class="p">]</span> <span class="o">||</span> <span class="mi">0</span>\<span class="p">)</span> \<span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><p>report += `| Expression | Occurrences |\n`;</p></li>
<li><p>report += `|————|————-|\n`;</p></li>
<li><p>Object.entries(allJsonExpressions)</p></li>
<li><p>.sort((a, b) =&gt; b[1] - a[1])</p></li>
<li><p>.slice(0, 20) // Top 20</p></li>
<li><p>.forEach(([expr, count]) =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>report \+= \`| \\\`${expr}\\\` | ${count} |\\n\`;  
</pre></div>
</div>
</li>
<li><p>// Expressions $node</p></li>
<li><p>report += `\n## Expressions $node Courantes\n\n`;</p></li>
<li><p>const allNodeExpressions = {};</p></li>
<li><p>wf.expressionTypes.node.forEach(expr =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">allNodeExpressions</span>\<span class="p">[</span><span class="n">cleaned</span>\<span class="p">]</span> \<span class="o">=</span> <span class="p">(</span><span class="n">allNodeExpressions</span>\<span class="p">[</span><span class="n">cleaned</span>\<span class="p">]</span> <span class="o">||</span> <span class="mi">0</span>\<span class="p">)</span> \<span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><p>Object.entries(allNodeExpressions)</p></li>
<li><p>// Variables et leur portée</p></li>
<li><p>report += `\n## Variables et leur Portée\n\n`;</p></li>
<li><p>report += `### Variables $json\n\n`;</p></li>
<li><p>report += `Les variables $json sont limitées au contexte de l’item courant</p></li>
<li><p>dans le workflow.\n\n`;</p></li>
<li><p>report += `### Variables $node\n\n`;</p></li>
<li><p>report += `Les variables $node permettent d’accéder aux données d’un nœud</p></li>
<li><p>spécifique, indépendamment du flux de données.\n\n`;</p></li>
<li><p>report += `### Variables $input\n\n`;</p></li>
<li><p>report += `Les variables $input sont utilisées principalement dans les nœuds</p></li>
<li><p>Code pour accéder aux données d’entrée.\n\n`;</p></li>
<li><p>// Expressions qui pourraient nécessiter une adaptation</p></li>
<li><p>report += `\n## Expressions Nécessitant Potentiellement une Adaptation\n\n`;</p></li>
<li><p>// Expressions faisant référence à des nœuds spécifiques</p></li>
<li><p>const nodeReferences = new Set();</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>const match \= expr.cleaned.match(/\\$node\\\[&quot;(\[^&quot;\]+)&quot;\\\]/);  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">nodeReferences</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">match</span>\<span class="p">[</span><span class="mi">1</span>\<span class="p">]);</span>  
</pre></div>
</div>
</li>
<li><p>report += `### Références à des Nœuds Spécifiques\n\n`;</p></li>
<li><p>report += `Les expressions suivantes font référence à des nœuds spécifiques et</p></li>
<li><p>pourraient nécessiter une adaptation dans la nouvelle architecture:\n\n`;</p></li>
<li><p>Array.from(nodeReferences).forEach(nodeName =&gt; {</p></li>
<li><p>report += `- \`$node[”${nodeName}”]\`\n`;</p></li>
<li><p>// Variables d’environnement</p></li>
<li><p>const envVariables = new Set();</p></li>
<li><p>wf.expressionTypes.env.forEach(expr =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>const match \= expr.cleaned.match(/\\$env\\.(\[a-zA-Z0-9\_\]+)/);  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">envVariables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">match</span>\<span class="p">[</span><span class="mi">1</span>\<span class="p">]);</span>  
</pre></div>
</div>
</li>
<li><p>if (envVariables.size &gt; 0) {</p></li>
<li><p>report += `\n### Variables d’Environnement\n\n`;</p></li>
<li><p>report += `Les variables d’environnement suivantes sont utilisées et devront</p></li>
<li><p>être configurées dans le nouvel environnement:\n\n`;</p></li>
<li><p>Array.from(envVariables).forEach(envVar =&gt; {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>report \+= \`- \\\`$env.${envVar}\\\`\\n\`;  
</pre></div>
</div>
</li>
<li><p>return [{ json: { report } }];</p></li>
</ul>
</li>
<li><p>Save Expressions Report</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.writeTextFile</p></li>
<li><p>“fileName”: “EMAIL_SENDER_EXPRESSIONS_REPORT.md”,</p></li>
<li><p>“text”: “={{ $json.report }}”,</p></li>
<li><p>“append”: false,</p></li>
<li><p>“encoding”: “utf8”</p></li>
</ul>
</li>
</ol>
</section>
<section id="diagramme-de-flux-pour-l-analyse-des-expressions-a-name-section-8-a">
<h4>1.1.0.6. Diagramme de Flux pour l’Analyse des Expressions <a name='section-8'></a><a class="headerlink" href="#diagramme-de-flux-pour-l-analyse-des-expressions-a-name-section-8-a" title="Link to this heading"></a></h4>
<p>Copy<br />┌─────────────────┐     ┌───────────────┐<br />thumb_up<br />thumb_down<br />Tu t’es interrompu juste avant “6. Save Expressions Report”, termine !<br />Augment<br />Je vais terminer le développement détaillé de la Phase 1, en reprenant à partir du diagramme de flux pour l’analyse des expressions.</p>
</section>
<section id="diagramme-de-flux-pour-l-analyse-des-expressions-a-name-section-9-a">
<h4>1.1.0.7. Diagramme de Flux pour l’Analyse des Expressions <a name='section-9'></a><a class="headerlink" href="#diagramme-de-flux-pour-l-analyse-des-expressions-a-name-section-9-a" title="Link to this heading"></a></h4>
<p>Copy<br />┌─────────────────┐     ┌───────────────┐     ┌──────────────────────┐<br />│                 │     │               │     │                      │<br />│  Manual Trigger │────▶│ Get Workflows │────▶│ Filter Email Sender  │<br />│                 │     │               │     │      Workflows       │<br />└─────────────────┘     └───────────────┘     └──────────────────────┘<br />│<br />▼<br />┌─────────────────┐     ┌───────────────────┐     ┌──────────────────┐<br />│  Save Expressions│◀────│ Generate Expressions│◀────│ Extract Expressions│<br />│    Report       │     │      Report       │     │                  │<br />└─────────────────┘     └───────────────────┘     └──────────────────┘</p>
</section>
<section id="workflow-de-duplication-automatisee-a-name-section-10-a">
<h4>1.1.0.8. Workflow de Duplication Automatisée <a name='section-10'></a><a class="headerlink" href="#workflow-de-duplication-automatisee-a-name-section-10-a" title="Link to this heading"></a></h4>
<p>Pour dupliquer les workflows existants et créer un environnement de test, nous allons créer un workflow d’automatisation.<br />Nœuds nécessaires :</p>
<ol>
<li><p>Start Node (Manual Trigger)</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.manualTrigger</p></li>
<li><p>Configuration : Standard</p></li>
</ul>
</li>
<li><p>Get Workflows</p>
<ul>
<li><p>Type : n8n-nodes-base.n8n</p></li>
<li><p>Configuration :</p></li>
<li><p>Copy</p></li>
<li><p>{</p></li>
<li><p>“resource”: “workflow”,</p></li>
<li><p>“operation”: “getAll”,</p></li>
<li><p>“options”: {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span>  
</pre></div>
</div>
</li>
<li><p>}</p></li>
</ul>
</li>
<li><p>Filter Email Sender Workflows</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.code</p></li>
<li><p>// Filtrer uniquement les workflows Email Sender</p></li>
<li><p>return items.filter(item =&gt; {</p></li>
<li><p>const name = item.json.name || ‘’;</p></li>
<li><p>return (name.includes(’EMAIL_SENDER’) || name.includes(’Email Sender’)) &amp;&amp;</p></li>
<li><p>!name.includes(’TEST_’);</p></li>
<li><p>});</p></li>
</ul>
</li>
<li><p>Prepare Duplicate Workflows</p>
<ul>
<li><p>// Préparer les workflows à dupliquer</p></li>
<li><p>const workflowsToDuplicate = [];</p></li>
<li><p>for (const item of items) {</p></li>
<li><p>const workflow = item.json;</p></li>
<li></li>
<li><p>// Créer une copie du workflow avec un nouveau nom</p></li>
<li><p>const duplicatedWorkflow = {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span><span class="n">workflow</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>name: \`TEST\_${workflow.name}\`,  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">active</span><span class="p">:</span> <span class="n">false</span> <span class="o">//</span> <span class="n">Désactiver</span> <span class="n">par</span> <span class="n">défaut</span>  
</pre></div>
</div>
</li>
<li><p>};</p></li>
<li><p>// Supprimer l’ID pour que n8n en génère un nouveau</p></li>
<li><p>delete duplicatedWorkflow.id;</p></li>
<li><p>workflowsToDuplicate.push({</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">json</span><span class="p">:</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">originalName</span><span class="p">:</span> <span class="n">workflow</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">duplicatedWorkflow</span>  
</pre></div>
</div>
</li>
<li><p>return workflowsToDuplicate;</p></li>
</ul>
</li>
<li><p>Create Duplicate Workflows</p>
<ul class="simple">
<li><p>“operation”: “create”,</p></li>
<li><p>“workflowData”: “={{ $json.duplicatedWorkflow }}”</p></li>
</ul>
</li>
<li><p>Generate Duplication Report</p>
<ul class="simple">
<li><p>// Générer un rapport sur les workflows dupliqués</p></li>
<li><p>const duplicatedWorkflows = items.map(item =&gt; ({</p></li>
<li><p>originalName: item.json.originalName,</p></li>
<li><p>newName: item.json.name,</p></li>
<li><p>newId: item.json.id</p></li>
<li><p>}));</p></li>
<li><p>let report = `# Rapport de Duplication des Workflows Email Sender\n\n`;</p></li>
<li><p>report += `Date de génération: ${new Date().toISOString()}\n\n`;</p></li>
<li><p>report += `## Workflows Dupliqués\n\n`;</p></li>
<li><p>report += `| Workflow Original | Workflow de Test | ID |\n`;</p></li>
<li><p>report += `|——————|—————–|—-|\n`;</p></li>
<li><p>duplicatedWorkflows.forEach(wf =&gt; {</p></li>
<li><p>report += `| ${wf.originalName} | ${wf.newName} | ${wf.newId} |\n`;</p></li>
<li><p>report += `\n## Prochaines Étapes\n\n`;</p></li>
<li><p>report += `1. Configurer les bases de données Notion de test\n`;</p></li>
<li><p>report += `2. Configurer un calendrier Google de test\n`;</p></li>
<li><p>report += `3. Mettre en place des comptes email de test\n`;</p></li>
<li><p>report += `4. Ajouter des nœuds de journalisation\n`;</p></li>
<li><p>return [{ json: { report } }];</p></li>
</ul>
</li>
<li><p>Save Duplication Report</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.writeTextFile</p></li>
<li><p>“fileName”: “EMAIL_SENDER_DUPLICATION_REPORT.md”,</p></li>
<li><p>“text”: “={{ $json.report }}”,</p></li>
<li><p>“append”: false,</p></li>
<li><p>“encoding”: “utf8”</p></li>
</ul>
</li>
</ol>
</section>
<section id="diagramme-de-flux-pour-la-duplication-des-workflows-a-name-section-11-a">
<h4>1.1.0.9. Diagramme de Flux pour la Duplication des Workflows <a name='section-11'></a><a class="headerlink" href="#diagramme-de-flux-pour-la-duplication-des-workflows-a-name-section-11-a" title="Link to this heading"></a></h4>
<p>Copy<br />┌─────────────────┐     ┌───────────────┐     ┌──────────────────────┐<br />│                 │     │               │     │                      │<br />│  Manual Trigger │────▶│ Get Workflows │────▶│ Filter Email Sender  │<br />│                 │     │               │     │      Workflows       │<br />└─────────────────┘     └───────────────┘     └──────────────────────┘<br />│<br />▼<br />┌─────────────────┐     ┌───────────────────┐     ┌──────────────────┐<br />│  Save Duplication│◀────│ Generate Duplication│◀────│ Create Duplicate │<br />│    Report       │     │      Report       │     │    Workflows     │<br />└─────────────────┘     └───────────────────┘     └──────────────────┘<br />▲<br />┌──────────────────┐<br />│                  │<br />│ Prepare Duplicate│<br />│    Workflows     │<br />│                  │<br />└──────────────────┘</p>
</section>
<section id="workflow-de-configuration-des-bases-de-donnees-de-test-a-name-section-12-a">
<h4>1.1.0.10. Workflow de Configuration des Bases de Données de Test <a name='section-12'></a><a class="headerlink" href="#workflow-de-configuration-des-bases-de-donnees-de-test-a-name-section-12-a" title="Link to this heading"></a></h4>
<p>Pour configurer les bases de données de test, nous allons créer un workflow qui duplique les bases de données Notion existantes.<br />Nœuds nécessaires :</p>
<ol>
<li><p>Start Node (Manual Trigger)</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.manualTrigger</p></li>
<li><p>Configuration : Standard</p></li>
</ul>
</li>
<li><p>Get Notion Databases</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.notion</p></li>
<li><p>Configuration :</p></li>
<li><p>Copy</p></li>
<li><p>{</p></li>
<li><p>“resource”: “database”,</p></li>
<li><p>“operation”: “getAll”</p></li>
<li><p>}</p></li>
</ul>
</li>
<li><p>Filter Relevant Databases</p>
<ul>
<li><p>Type : n8n-nodes-base.code</p></li>
<li><p>// Filtrer les bases de données pertinentes pour Email Sender</p></li>
<li><p>const relevantDatabases = [];</p></li>
<li><p>const keywordFilters = [’LOT1’, ‘Dispo’, ‘Booking’, ‘Contact’];</p></li>
<li><p>for (const item of items) {</p></li>
<li><p>const database = item.json;</p></li>
<li><p>const title = database.title?.[0]?.plain_text || ‘’;</p></li>
<li></li>
<li><p>// Vérifier si le titre contient l’un des mots-clés</p></li>
<li><p>if (keywordFilters.some(keyword =&gt; title.includes(keyword))) {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">relevantDatabases</span><span class="o">.</span><span class="n">push</span><span class="p">({</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">json</span><span class="p">:</span> <span class="p">{</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="nb">id</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">title</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">properties</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">url</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">url</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">});</span>  
</pre></div>
</div>
</li>
<li><p>return relevantDatabases;</p></li>
</ul>
</li>
<li><p>Prepare Test Database Configuration</p>
<ul>
<li><p>// Préparer la configuration des bases de données de test</p></li>
<li><p>const testDatabases = [];</p></li>
<li><p>testDatabases.push({</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">originalId</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">originalTitle</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  testTitle: \`TEST\_${database.title}\`,  
</pre></div>
</div>
</li>
<li><p>return testDatabases;</p></li>
</ul>
</li>
<li><p>Generate Database Configuration Guide</p>
<ul class="simple">
<li><p>// Générer un guide de configuration pour les bases de données de test</p></li>
<li><p>const databases = items.map(item =&gt; item.json);</p></li>
<li><p>let guide = `# Guide de Configuration des Bases de Données de Test\n\n`;</p></li>
<li><p>guide += `Date de génération: ${new Date().toISOString()}\n\n`;</p></li>
<li><p>guide += `## Bases de Données à Dupliquer\n\n`;</p></li>
<li><p>guide += `| Base de Données Originale | ID | URL |\n`;</p></li>
<li><p>guide += `|—————————|—-|—-|`;</p></li>
<li><p>databases.forEach(db =&gt; {</p></li>
<li><p>guide += `\n| ${db.originalTitle} | ${db.originalId} | ${db.url} |`;</p></li>
<li><p>guide += `\n\n## Instructions de Duplication\n\n`;</p></li>
<li><p>guide += `Pour chaque base de données listée ci-dessus, suivez ces</p></li>
<li><p>étapes:\n\n`;</p></li>
<li><p>guide += `1. Ouvrez la base de données dans Notion en utilisant l’URL</p></li>
<li><p>fournie\n`;</p></li>
<li><p>guide += `2. Cliquez sur les trois points (…) dans le coin supérieur</p></li>
<li><p>droit\n`;</p></li>
<li><p>guide += `3. Sélectionnez “Duplicate”\n`;</p></li>
<li><p>guide += `4. Renommez la copie en ajoutant le préfixe “TEST_”\n`;</p></li>
<li><p>guide += `5. Videz le contenu de la base de données dupliquée (supprimez</p></li>
<li><p>toutes les entrées)\n`;</p></li>
<li><p>guide += `6. Ajoutez quelques entrées de test\n\n`;</p></li>
<li><p>guide += `## Configuration des Credentials Notion\n\n`;</p></li>
<li><p>guide += `Après avoir dupliqué toutes les bases de données, vous devrez:\n\n`;</p></li>
<li><p>guide += `1. Créer un nouvel intégration Notion pour l’environnement de</p></li>
<li><p>test\n`;</p></li>
<li><p>guide += `2. Partager chaque base de données dupliquée avec cette nouvelle</p></li>
<li><p>intégration\n`;</p></li>
<li><p>guide += `3. Créer un nouveau credential Notion dans n8n avec le token de</p></li>
<li><p>cette intégration\n`;</p></li>
<li><p>guide += `4. Mettre à jour les workflows de test pour utiliser ce nouveau</p></li>
<li><p>credential\n\n`;</p></li>
<li><p>guide += `## Mise à Jour des IDs de Base de Données\n\n`;</p></li>
<li><p>guide += `Après avoir dupliqué les bases de données, vous devrez mettre à jour</p></li>
<li><p>les IDs dans les workflows de test:\n\n`;</p></li>
<li><p>guide += `- Remplacer l’ID \`${db.originalId}\` par l’ID de la nouvelle base</p></li>
<li><p>de données \`TEST_${db.originalTitle}\`\n`;</p></li>
<li><p>return [{ json: { guide } }];</p></li>
</ul>
</li>
<li><p>Save Database Configuration Guide</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.writeTextFile</p></li>
<li><p>“fileName”: “EMAIL_SENDER_TEST_DATABASES_GUIDE.md”,</p></li>
<li><p>“text”: “={{ $json.guide }}”,</p></li>
<li><p>“append”: false,</p></li>
<li><p>“encoding”: “utf8”</p></li>
</ul>
</li>
</ol>
</section>
<section id="diagramme-de-flux-pour-la-configuration-des-bases-de-donnees-de-test-a-name-section-13-a">
<h4>1.1.0.11. Diagramme de Flux pour la Configuration des Bases de Données de Test <a name='section-13'></a><a class="headerlink" href="#diagramme-de-flux-pour-la-configuration-des-bases-de-donnees-de-test-a-name-section-13-a" title="Link to this heading"></a></h4>
<p>Copy<br />┌─────────────────┐     ┌───────────────────┐     ┌──────────────────────┐<br />│                 │     │                   │     │                      │<br />│  Manual Trigger │────▶│ Get Notion Databases │──▶│ Filter Relevant     │<br />│                 │     │                   │     │    Databases         │<br />└─────────────────┘     └───────────────────┘     └──────────────────────┘<br />│<br />▼<br />┌─────────────────────┐     ┌───────────────────────┐     ┌──────────────────┐<br />│  Save Database      │◀────│ Generate Database     │◀────│ Prepare Test     │<br />│  Configuration Guide│     │ Configuration Guide   │     │ Database Config  │<br />└─────────────────────┘     └───────────────────────┘     └──────────────────┘</p>
</section>
<section id="workflow-de-creation-du-systeme-de-journalisation-a-name-section-14-a">
<h4>1.1.0.12. Workflow de Création du Système de Journalisation <a name='section-14'></a><a class="headerlink" href="#workflow-de-creation-du-systeme-de-journalisation-a-name-section-14-a" title="Link to this heading"></a></h4>
<p>Pour mettre en place un système de journalisation, nous allons créer un workflow central de journalisation et des nœuds réutilisables.<br />Nœuds nécessaires pour le Workflow Central de Journalisation :</p>
<ol>
<li><p>Start Node (Webhook Trigger)</p>
<ul>
<li><p>Type : n8n-nodes-base.webhook</p></li>
<li><p>Configuration :</p></li>
<li><p>Copy</p></li>
<li><p>{</p></li>
<li><p>“path”: “log”,</p></li>
<li><p>“responseMode”: “onReceived”,</p></li>
<li><p>“options”: {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;responseData&quot;</span><span class="p">:</span> <span class="s2">&quot;firstEntryJson&quot;</span>  
</pre></div>
</div>
</li>
<li><p>}</p></li>
</ul>
</li>
<li><p>Process Log Entry</p>
<ul>
<li><p>Type : n8n-nodes-base.code</p></li>
<li><p>// Traiter l’entrée de journal</p></li>
<li><p>const logEntry = $json;</p></li>
<li><p>// Ajouter un timestamp s’il n’existe pas</p></li>
<li><p>if (!logEntry.timestamp) {</p></li>
<li><p>logEntry.timestamp = new Date().toISOString();</p></li>
<li><p>// Standardiser le format</p></li>
<li><p>const standardizedEntry = {</p></li>
<li><p>timestamp: logEntry.timestamp,</p></li>
<li><p>level: logEntry.level || ‘INFO’,</p></li>
<li><p>source: logEntry.source || ‘Unknown’,</p></li>
<li><p>message: logEntry.message || ‘’,</p></li>
<li><p>details: logEntry.details || {},</p></li>
<li><p>workflow: {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span><span class="p">:</span> <span class="n">logEntry</span><span class="o">.</span><span class="n">workflowId</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="p">:</span> <span class="n">logEntry</span><span class="o">.</span><span class="n">workflowName</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span>  
</pre></div>
</div>
</li>
<li><p>},</p></li>
<li><p>node: {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span><span class="p">:</span> <span class="n">logEntry</span><span class="o">.</span><span class="n">nodeId</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="p">:</span> <span class="n">logEntry</span><span class="o">.</span><span class="n">nodeName</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span>  
</pre></div>
</div>
</li>
<li><p>};</p></li>
<li><p>// Ajouter une représentation formatée pour l’affichage</p></li>
<li><p>standardizedEntry.formatted = `[${standardizedEntry.timestamp}] [$</p></li>
<li><p>{standardizedEntry.level}] [${standardizedEntry.source}] ${standardizedEntry.</p></li>
<li><p>message}`;</p></li>
<li><p>return { json: standardizedEntry };</p></li>
</ul>
</li>
<li><p>Save Log to File</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.writeTextFile</p></li>
<li><p>“fileName”: “EMAIL_SENDER_LOGS.jsonl”,</p></li>
<li><p>“text”: “={{ JSON.stringify($json) + ‘\\n’ }}”,</p></li>
<li><p>“append”: true,</p></li>
<li><p>“encoding”: “utf8”</p></li>
</ul>
</li>
<li><p>Conditional Alert for Errors</p>
<ul>
<li><p>Type : n8n-nodes-base.if</p></li>
<li><p>“conditions”: {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;string&quot;</span><span class="p">:</span> \<span class="p">[</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="s2">&quot;value1&quot;</span><span class="p">:</span> <span class="s2">&quot;={{ $json.level }}&quot;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;equals&quot;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="s2">&quot;value2&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>\<span class="p">]</span>  
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Send Error Alert (If True Branch)</p>
<ul class="simple">
<li><p>Type : n8n-nodes-base.emailSend</p></li>
<li><p>“fromEmail”: “alerts&#64;example.com”,</p></li>
<li><p>“toEmail”: “admin&#64;example.com”,</p></li>
<li><p>“subject”: “EMAIL SENDER ERROR: {{ $json.message }}”,</p></li>
<li><p>“text”: “=Error details:\n\nTimestamp: {{ $json.timestamp }}\nSource: {{</p></li>
<li><p>$json.source }}\nWorkflow: {{ $json.workflow.name }}\nNode: {{ $json.node.</p></li>
<li><p>name }}\n\nMessage: {{ $json.message }}\n\nDetails: {{ JSON.stringify($json.</p></li>
<li><p>details, null, 2) }}”</p></li>
</ul>
</li>
</ol>
<p>Nœud de Journalisation Réutilisable (à ajouter aux workflows de test) :</p>
<ol>
<li><p>Logger Node (Code)</p>
<ul>
<li><p>// Nœud de journalisation réutilisable</p></li>
<li><p>// Configuration</p></li>
<li><p>const config = {</p></li>
<li><p>logLevel: ‘INFO’, // Peut être ‘DEBUG’, ‘INFO’, ‘WARNING’, ‘ERROR’</p></li>
<li><p>source: $workflow.name || ‘Unknown’,</p></li>
<li><p>logEndpoint: ‘http://localhost:5678/webhook/log’ // URL du webhook de</p></li>
<li><p>journalisation</p></li>
<li><p>// Fonction de journalisation</p></li>
<li><p>const log = async (level, message, details = {}) =&gt; {</p></li>
<li><p>// Ne journaliser que si le niveau est suffisant</p></li>
<li><p>const levels = { ‘DEBUG’: 0, ‘INFO’: 1, ‘WARNING’: 2, ‘ERROR’: 3 };</p></li>
<li><p>if (levels[level] &lt; levels[config.logLevel]) {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">null</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li></li>
<li><p>// Créer l’entrée de journal</p></li>
<li><p>const logEntry = {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">timestamp</span><span class="p">:</span> <span class="n">new</span> <span class="n">Date</span><span class="p">()</span><span class="o">.</span><span class="n">toISOString</span><span class="p">(),</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">level</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">message</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">details</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>workflowId: $workflow.id,  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>workflowName: $workflow.name,  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>nodeId: $node.id,  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>nodeName: $node.name  
</pre></div>
</div>
</li>
<li><p>// Envoyer au webhook de journalisation</p></li>
<li><p>try {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>const response \= await $http.post(config.logEndpoint, logEntry);  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">response</span><span class="p">;</span>  
</pre></div>
</div>
</li>
<li><p>} catch (error) {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to send log entry:&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">);</span>  
</pre></div>
</div>
</li>
<li><p>// Journaliser l’entrée actuelle</p></li>
<li><p>const message = $json.message || ‘No message provided’;</p></li>
<li><p>const level = $json.level || ‘INFO’;</p></li>
<li><p>const details = $json.details || {};</p></li>
<li><p>log(level, message, details);</p></li>
<li><p>// Retourner l’item original pour ne pas perturber le flux</p></li>
<li><p>return items;</p></li>
</ul>
</li>
<li><p>Logger Workflow Subworkflow</p>
<ul>
<li><p>Type : n8n-nodes-base.executeWorkflow</p></li>
<li><p>“workflowId”: “={{ $json.loggerWorkflowId }}”,</p></li>
<li><p>“additionalData”: {</p></li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;={{ $json.level || &#39;INFO&#39; }}&quot;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;={{ $json.message }}&quot;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;={{ $json.details || </span><span class="si">{}</span><span class="s2"> }}&quot;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;={{ $workflow.name }}&quot;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;workflowId&quot;</span><span class="p">:</span> <span class="s2">&quot;={{ $workflow.id }}&quot;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;workflowName&quot;</span><span class="p">:</span> <span class="s2">&quot;={{ $workflow.name }}&quot;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;nodeId&quot;</span><span class="p">:</span> <span class="s2">&quot;={{ $node.id }}&quot;</span><span class="p">,</span>  
</pre></div>
</div>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;nodeName&quot;</span><span class="p">:</span> <span class="s2">&quot;={{ $node.name }}&quot;</span>  
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</section>
<section id="diagramme-de-flux-pour-le-systeme-de-journalisation-a-name-section-15-a">
<h4>1.1.0.13. Diagramme de Flux pour le Système de Journalisation <a name='section-15'></a><a class="headerlink" href="#diagramme-de-flux-pour-le-systeme-de-journalisation-a-name-section-15-a" title="Link to this heading"></a></h4>
<p>Copy<br />┌─────────────────┐     ┌───────────────────┐     ┌──────────────────────┐<br />│                 │     │                   │     │                      │<br />│ Webhook Trigger │────▶│ Process Log Entry │────▶│ Save Log to File     │<br />└─────────────────┘     └───────────────────┘     └──────────────────────┘<br />│<br />▼<br />┌──────────────────────┐<br />│                      │<br />│ Conditional Alert    │<br />│    for Errors        │<br />└──────────────────────┘<br />┌──────┴──────┐<br />│             │<br />▼             ▼<br />┌─────────────────┐      (End)<br />│                 │<br />│ Send Error Alert│<br />│                 │<br />└─────────────────┘</p>
</section>
<section id="diagramme-d-integration-du-systeme-de-journalisation-dans-les-workflows-de-test-a-name-section-16-a">
<h4>1.1.0.14. Diagramme d’Intégration du Système de Journalisation dans les Workflows de Test <a name='section-16'></a><a class="headerlink" href="#diagramme-d-integration-du-systeme-de-journalisation-dans-les-workflows-de-test-a-name-section-16-a" title="Link to this heading"></a></h4>
<p>Copy<br />┌─────────────────┐     ┌───────────────────┐     ┌──────────────────────┐<br />│                 │     │                   │     │                      │<br />│ Workflow Node   │────▶│ Processing Node   │────▶│ Next Node            │<br />└─────────────────┘     └───────────────────┘     └──────────────────────┘<br />│<br />▼<br />┌─────────────────┐<br />│                 │<br />│ Logger Node     │────────────────┐<br />│                 │                │<br />└─────────────────┘                │<br />│<br />│<br />▼<br />┌──────────────────────┐<br />│                      │<br />│ Central Logging      │<br />│    Workflow          │<br />└──────────────────────┘</p>
</section>
<section id="liens-avec-les-phases-precedentes-a-name-section-17-a">
<h4>1.1.1. Liens avec les Phases Précédentes <a name='section-17'></a><a class="headerlink" href="#liens-avec-les-phases-precedentes-a-name-section-17-a" title="Link to this heading"></a></h4>
<p>Cette Phase 1 est la première étape du plan de transition, donc il n’y a pas de phase précédente à proprement parler. Cependant, elle s’appuie sur l’état actuel des workflows Email Sender, qui sont organisés en 6 phases distinctes:</p>
<ol class="simple">
<li><p>Phase 1: Gestion des Disponibilités</p></li>
<li><p>Phase 2: Génération &amp; Envoi des Emails</p></li>
<li><p>Phase 3: Traitement des Réponses</p></li>
<li><p>Phase 4: Gestion des Concerts Confirmés</p></li>
<li><p>Phase 5: Suivi Post-Concert</p></li>
<li><p>Phase 6: Évaluation et Planification Future</p></li>
</ol>
</section>
<section id="liens-avec-les-phases-suivantes-a-name-section-18-a">
<h4>1.1.2. Liens avec les Phases Suivantes <a name='section-18'></a><a class="headerlink" href="#liens-avec-les-phases-suivantes-a-name-section-18-a" title="Link to this heading"></a></h4>
<p>La Phase 1 (Analyse et Préparation) prépare le terrain pour les phases suivantes du plan de transition:</p>
<ol class="simple">
<li><p>Phase 2: Refactorisation et Standardisation</p>
<ul class="simple">
<li><p>Utilise les rapports générés dans la Phase 1 pour standardiser les noms, optimiser les nœuds Code et standardiser les structures de données.</p></li>
</ul>
</li>
<li><p>Phase 3: Intégration avec le Plan Magistral V5</p>
<ul class="simple">
<li><p>S’appuie sur l’environnement de test créé dans la Phase 1 pour mettre en place les piliers du Plan Magistral V5.</p></li>
</ul>
</li>
<li><p>Phase 4: Tests et Validation</p>
<ul class="simple">
<li><p>Utilise le système de journalisation mis en place dans la Phase 1 pour surveiller et valider les tests.</p></li>
</ul>
</li>
<li><p>Phase 5: Déploiement et Suivi</p>
<ul class="simple">
<li><p>Utilise les rapports et la documentation générés dans la Phase 1 pour guider le déploiement et le suivi.</p></li>
</ul>
</li>
</ol>
</section>
<section id="taches-regulieres-repetitives-a-name-section-19-a">
<h4>1.1.3. Tâches Régulières Répétitives <a name='section-19'></a><a class="headerlink" href="#taches-regulieres-repetitives-a-name-section-19-a" title="Link to this heading"></a></h4>
<ol class="simple">
<li><p>Surveillance des Logs</p>
<ul class="simple">
<li><p>Fréquence: Toutes les heures</p></li>
<li><p>Description: Analyse les logs générés par le système de journalisation pour détecter des problèmes potentiels.</p></li>
<li><p>Implémentation: Workflow Cron qui lit le fichier de logs, analyse les entrées récentes et génère des alertes si nécessaire.</p></li>
</ul>
</li>
<li><p>Vérification des Credentials</p>
<ul class="simple">
<li><p>Fréquence: Quotidienne</p></li>
<li><p>Description: Vérifie que tous les credentials sont valides et fonctionnels.</p></li>
<li><p>Implémentation: Workflow Cron qui teste chaque credential en effectuant une opération simple et journalise les résultats.</p></li>
</ul>
</li>
<li><p>Sauvegarde des Workflows</p>
<ul class="simple">
<li><p>Description: Exporte tous les workflows et les sauvegarde dans un emplacement sécurisé.</p></li>
<li><p>Implémentation: Workflow Cron qui utilise l’API n8n pour exporter les workflows et les sauvegarder.</p></li>
</ul>
</li>
</ol>
</section>
<section id="evenements-de-fond-a-name-section-20-a">
<h4>1.1.4. Événements de Fond <a name='section-20'></a><a class="headerlink" href="#evenements-de-fond-a-name-section-20-a" title="Link to this heading"></a></h4>
<ol class="simple">
<li><p>Surveillance des Erreurs</p>
<ul class="simple">
<li><p>Déclencheur: Entrée de log de niveau ERROR</p></li>
<li><p>Description: Envoie une alerte par email et/ou Slack lorsqu’une erreur est détectée.</p></li>
<li><p>Implémentation: Webhook qui écoute les entrées de log et déclenche des alertes en fonction du niveau de gravité.</p></li>
</ul>
</li>
<li><p>Mise à Jour des Rapports</p>
<ul class="simple">
<li><p>Déclencheur: Modification d’un workflow</p></li>
<li><p>Description: Met à jour les rapports d’inventaire, de credentials et d’expressions lorsqu’un workflow est modifié.</p></li>
<li><p>Implémentation: Webhook qui écoute les événements de modification de workflow et déclenche les workflows d’analyse.</p></li>
</ul>
</li>
<li><p>Synchronisation des Environnements</p>
<ul class="simple">
<li><p>Déclencheur: Déploiement d’un changement dans l’environnement de production</p></li>
<li><p>Description: Synchronise les changements entre l’environnement de production et l’environnement de test.</p></li>
<li><p>Implémentation: Webhook qui écoute les événements de déploiement et déclenche un workflow de synchronisation.</p></li>
</ul>
</li>
</ol>
</section>
</section>
<section id="conclusion-a-name-section-21-a">
<h3>1.2. Conclusion <a name='section-21'></a><a class="headerlink" href="#conclusion-a-name-section-21-a" title="Link to this heading"></a></h3>
<p>La Phase 1 du plan de transition est une étape cruciale qui pose les fondations pour la migration vers le Plan Magistral V5. Elle comprend une analyse approfondie des workflows existants, la création d’un environnement de test et la mise en place d’un système de journalisation robuste.<br />Les workflows et outils développés dans cette phase permettront de:</p>
<ul class="simple">
<li><p>Comprendre en détail la structure et le fonctionnement des workflows existants</p></li>
<li><p>Identifier les dépendances et les points d’intégration</p></li>
<li><p>Créer un environnement de test isolé pour expérimenter sans risque</p></li>
<li><p>Mettre en place un système de surveillance et de journalisation pour faciliter le débogage</p></li>
</ul>
<p>Une fois cette phase terminée, l’équipe disposera de toutes les informations et outils nécessaires pour procéder à la refactorisation et à la standardisation des workflows dans la Phase 2.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, EMAIL_SENDER_1 Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>