{
  "name": "Email Sender - Phase 3 (Traitement des Réponses)",
  "nodes": [
    {
      "parameters": {
        "resource": "message",
        "operation": "getAll",
        "limit": 10,
        "filters": {
          "subject": "Re: Proposition – Groupe en tournée (automatisé)"
        },
        "options": {
          "onlyWithAttachments": false
        }
      },
      "id": "8d417011-1f73-4706-abeb-be21c52f1195",
      "name": "Trigger Gmail Réponse",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        580,
        300
      ],
      "credentials": {
        "gmailOAuth2": {
          "id": "xKa629oVYYGTlvnn",
          "name": "Gmail account 2"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "1c481449-f795-8095-a5cf-cc4418e7ddb7",
          "mode": "list",
          "cachedResultName": "LOT1",
          "cachedResultUrl": "https://www.notion.so/1c481449f7958095a5cfcc4418e7ddb7"
        },
        "options": {}
      },
      "id": "c51a167d-b1de-4f76-a30e-ceca5b8c8742",
      "name": "Cherche Email Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 1,
      "position": [
        800,
        300
      ],
      "credentials": {
        "notionApi": {
          "id": "gFvw0ObPabSVTQIp",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Analyse des réponses aux emails\nconst emailContent = $json.body || $json.content || '';\n\n// Mots-clés pour détecter l'intention\nconst keywords = {\n  interest: ['intéressé', 'intéressant', 'possible', 'pourquoi pas'],\n  negotiation: ['tarif', 'prix', 'cachet', 'budget', 'coût'],\n  confirmation: ['confirm', 'réserv', 'valid', 'accord', 'ok pour'],\n  rejection: ['désolé', 'malheureusement', 'pas possible', 'complet']\n};\n\n// Détection des mots-clés\nlet isInterested = false;\nlet isNegotiating = false;\nlet isConfirming = false;\nlet isRejecting = false;\n\n// Vérification pour chaque catégorie\nfor (const keyword of keywords.interest) {\n  if (emailContent.toLowerCase().includes(keyword.toLowerCase())) {\n    isInterested = true;\n    break;\n  }\n}\n\nfor (const keyword of keywords.negotiation) {\n  if (emailContent.toLowerCase().includes(keyword.toLowerCase())) {\n    isNegotiating = true;\n    break;\n  }\n}\n\nfor (const keyword of keywords.confirmation) {\n  if (emailContent.toLowerCase().includes(keyword.toLowerCase())) {\n    isConfirming = true;\n    break;\n  }\n}\n\nfor (const keyword of keywords.rejection) {\n  if (emailContent.toLowerCase().includes(keyword.toLowerCase())) {\n    isRejecting = true;\n    break;\n  }\n}\n\n// Détermination du statut global\nlet status = 'Indéterminé';\nif (isConfirming) {\n  status = 'Confirmation';\n} else if (isNegotiating) {\n  status = 'Négociation';\n} else if (isInterested) {\n  status = 'Intéressé';\n} else if (isRejecting) {\n  status = 'Refus';\n}\n\n// Retourne les données enrichies\nreturn [{\n  json: {\n    ...($json || {}),\n    emailContent,\n    intention: {\n      isInterested,\n      isNegotiating,\n      isConfirming,\n      isRejecting\n    },\n    status,\n    analysisTimestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d",
      "name": "Analyse IA Réponse",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1020,
        300
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "databaseId": {
          "__rl": true,
          "value": "1c481449-f795-8095-a5cf-cc4418e7ddb7",
          "mode": "list",
          "cachedResultName": "LOT1",
          "cachedResultUrl": "https://www.notion.so/1c481449f7958095a5cfcc4418e7ddb7"
        },
        "pageId": "={{ $json.id }}",
        "properties": {
          "Status": {
            "status": {
              "name": "={{ $json.status }}"
            }
          },
          "Réponse": {
            "rich_text": [
              {
                "text": {
                  "content": "={{ $json.emailContent.substring(0, 2000) }}"
                }
              }
            ]
          }
        }
      },
      "id": "8a8459bc-d38a-43ef-92b3-5517ba97a1a1",
      "name": "Update Notion Répondu",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 1,
      "position": [
        1240,
        300
      ],
      "credentials": {
        "notionApi": {
          "id": "gFvw0ObPabSVTQIp",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.status }}",
              "operation": "equals",
              "value2": "Confirmation"
            }
          ]
        }
      },
      "id": "47f136ed-17fc-4e0d-b8e2-c1c48c52d589",
      "name": "Check DEAL",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1460,
        300
      ]
    },
    {
      "parameters": {
        "content": "## ✅ Phase 3: Traitement des Réponses\n\nDéclencheur: Trigger Gmail Réponse\nObjectif: Analyser les réponses reçues et mettre à jour Notion",
        "height": 280,
        "width": 1220,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        560,
        180
      ],
      "id": "429a26dc-88cf-45c5-98c4-65528ad50da3",
      "name": "Sticky Note Phase 3"
    }
  ],
  "connections": {
    "Trigger Gmail Réponse": {
      "main": [
        [
          {
            "node": "Cherche Email Notion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cherche Email Notion": {
      "main": [
        [
          {
            "node": "Analyse IA Réponse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyse IA Réponse": {
      "main": [
        [
          {
            "node": "Update Notion Répondu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Notion Répondu": {
      "main": [
        [
          {
            "node": "Check DEAL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "versionId": "5a8b8a8a-8a8a-4a8a-8a8a-8a8a8a8a8a8a",
  "id": "3",
  "meta": {
    "instanceId": "b888bd11d2a9b7f1b279386f140a9b78c55afa0dbe4a6d35f4590595b0503772"
  },
  "tags": [
    {
      "name": "Phase 3",
      "color": "#ffcc00"
    }
  ]
}
